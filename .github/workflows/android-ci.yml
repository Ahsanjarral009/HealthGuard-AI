name: Android CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'android/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'android/**'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Android SDK
      run: |
        ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
        
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
        mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
        unzip -q cmdline-tools.zip -d $ANDROID_SDK_ROOT/cmdline-tools
        mv $ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools $ANDROID_SDK_ROOT/cmdline-tools/latest
        rm cmdline-tools.zip
        
        mkdir -p ~/.android
        touch ~/.android/repositories.cfg
        yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses
        
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "platform-tools" "build-tools;33.0.2" "platforms;android-33"
        
        echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
        echo "$ANDROID_SDK_ROOT/build-tools/33.0.2" >> $GITHUB_PATH
    
    - name: Cache Gradle
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('android/gradle/wrapper/gradle-wrapper.properties') }}-${{ hashFiles('android/**/*.gradle*') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Build APK
      run: |
        cd android
        chmod +x gradlew
        ./gradlew assembleRelease --no-daemon
    
    - name: Verify APK exists
      run: |
        if [ ! -f "android/app/build/outputs/apk/release/app-release.apk" ]; then
          echo "APK not found! Listing directory contents:"
          find android/app/build/outputs/apk -type f 2>/dev/null || true
          exit 1
        fi
        echo "APK found: android/app/build/outputs/apk/release/app-release.apk"
        ls -la android/app/build/outputs/apk/release/
    
    - name: Upload APK to S3
      if: github.ref == 'refs/heads/main'
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: ${{ secrets.AWS_REGION }}
      run: |
        if ! command -v aws &> /dev/null; then
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install
        fi
        
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        APK_NAME="app-$TIMESTAMP.apk"
        
        aws s3 cp android/app/build/outputs/apk/release/app-release.apk \
          s3://${{ secrets.ANDROID_S3_BUCKET }}/releases/$APK_NAME
        
        aws s3 cp android/app/build/outputs/apk/release/app-release.apk \
          s3://${{ secrets.ANDROID_S3_BUCKET }}/latest/app-latest.apk
        
        APK_URL="https://${{ secrets.ANDROID_S3_BUCKET }}.s3.${{ secrets.AWS_REGION }}.amazonaws.com/releases/$APK_NAME"
        echo "APK URL: $APK_URL"
        echo "Latest APK URL: https://${{ secrets.ANDROID_S3_BUCKET }}.s3.${{ secrets.AWS_REGION }}.amazonaws.com/latest/app-latest.apk"
    
    - name: Upload APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-release
        path: android/app/build/outputs/apk/release/app-release.apk
        retention-days: 7
    
    - name: Create GitHub Release (Optional)
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        files: android/app/build/outputs/apk/release/app-release.apk
        tag_name: release-${{ github.run_id }}
        name: Release ${{ github.run_id }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
