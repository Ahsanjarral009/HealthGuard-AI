name: Deploy FastAPI Backend

on:
  push:
    branches: [ main ]
    paths:
      - 'Backend FastApi/Smart_Disease_Prediction_System/**'
      - '.github/workflows/fastapi-deploy.yml'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'Backend FastApi/Smart_Disease_Prediction_System/requirements.txt'
    
    - name: Install dependencies
      run: |
        cd "Backend FastApi/Smart_Disease_Prediction_System"
        pip install -r requirements.txt
    
    - name: Run tests
      run: |
        cd "Backend FastApi/Smart_Disease_Prediction_System"
        if [ -d "tests" ]; then
          python -m pytest tests/ -v
        else
          echo "No tests directory found"
        fi
    
    - name: Validate FastAPI app
      run: |
        cd "Backend FastApi/Smart_Disease_Prediction_System"
        python -c "
        try:
            from main import app
            print('‚úÖ FastAPI app can be imported successfully')
        except Exception as e:
            print(f'‚ùå Import error: {e}')
            exit(1)
        "

  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: success()
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script_stop: true
        timeout: 300
        script: |
          set -e
          
          DEPLOY_USER=ubuntu
          APP_DIR="/var/www/fastapi-app"
          BACKUP_DIR="/var/www/backups"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          SRC_DIR="$APP_DIR/Backend FastApi/Smart_Disease_Prediction_System"
          
          sudo mkdir -p "$BACKUP_DIR"
          sudo mkdir -p "$APP_DIR"
          
          cd "$APP_DIR"
          
          # If repo not cloned, clone it
          if [ ! -d ".git" ]; then
            echo "üì• Cloning repository..."
            git clone https://github.com/YOUR_USERNAME/YOUR_REPO.git .
          fi
          
          git fetch origin
          git reset --hard origin/main
          
          echo "üì¶ Backing up current application..."
          sudo tar -czf "$BACKUP_DIR/app-backup-$TIMESTAMP.tar.gz" \
            --exclude='venv' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            -C "$APP_DIR" .
          
          echo "üìÇ Copying backend files..."
          rsync -av --delete \
            --exclude='.env' \
            --exclude='*.db' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            "$SRC_DIR/" "$APP_DIR/"
          
          if [ ! -f ".env" ] && [ -f ".env.example" ]; then
            cp .env.example .env
          fi
          
          echo "üîß Setting up virtual environment..."
          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi
          
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          
          echo "üîß Creating systemd service..."
          sudo tee /etc/systemd/system/fastapi.service > /dev/null <<EOF
[Unit]
Description=FastAPI Application
After=network.target

[Service]
User=$DEPLOY_USER
Group=www-data
WorkingDirectory=$APP_DIR
Environment="PATH=$APP_DIR/venv/bin"
ExecStart=$APP_DIR/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

          sudo systemctl daemon-reload
          sudo systemctl restart fastapi.service
          
          sleep 5
          
          sudo systemctl status fastapi.service --no-pager | head -20
          
          if curl -f -s http://localhost:8000/health > /dev/null 2>&1; then
            echo "‚úÖ Health check passed"
          else
            echo "‚ùå Health check failed"
            sudo journalctl -u fastapi.service -n 50 --no-pager
            exit 1
          fi

    - name: Send deployment notification
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "‚úÖ Deployment successful!"
        else
          echo "‚ùå Deployment failed!"
        fi
