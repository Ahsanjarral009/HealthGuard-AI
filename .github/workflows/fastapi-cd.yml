name: FastAPI Deploy

on:
  push:
    branches: [ main ]
    paths:
      - 'fastapi/**'
  workflow_dispatch:  # Allow manual trigger

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'  # Specify your Python version
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        cd fastapi
        pip install -r requirements.txt
        pip install pytest pytest-asyncio httpx  # Add test dependencies
    
    - name: Run tests
      run: |
        cd fastapi
        python -m pytest tests/ -v
    
    - name: Lint code
      run: |
        cd fastapi
        pip install black flake8 mypy
        black --check .
        flake8 .
        mypy --ignore-missing-imports .

  deploy:
    runs-on: ubuntu-latest
    needs: test  # Only deploy if tests pass
    if: success()
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Package and prepare deployment
      run: |
        # Create deployment package
        cd fastapi
        tar -czf ../deployment.tar.gz --exclude='__pycache__' --exclude='*.pyc' .
        echo "DEPLOY_TIMESTAMP=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_ENV
    
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script_stop: true  # Stop on first error
        script: |
          set -e  # Exit on error
          
          # Configuration
          APP_DIR="/var/www/fastapi-app"
          BACKUP_DIR="/var/www/backups"
          DEPLOY_TIMESTAMP="${{ env.DEPLOY_TIMESTAMP }}"
          
          # Create backup directory
          sudo mkdir -p $BACKUP_DIR
          
          echo "Starting deployment at $(date)"
          
          # 1. Backup current application
          if [ -d "$APP_DIR" ]; then
            echo "Backing up current application..."
            sudo tar -czf "$BACKUP_DIR/fastapi-backup-$DEPLOY_TIMESTAMP.tar.gz" -C "$APP_DIR" .
          fi
          
          # 2. Create or update virtual environment
          echo "Setting up virtual environment..."
          if [ ! -d "$APP_DIR/venv" ]; then
            sudo python3 -m venv $APP_DIR/venv
          fi
          
          # 3. Extract new code
          echo "Extracting new code..."
          sudo mkdir -p $APP_DIR
          sudo tar -xzf /tmp/deployment.tar.gz -C $APP_DIR
          
          # 4. Activate venv and install dependencies
          echo "Installing dependencies..."
          cd $APP_DIR
          source venv/bin/activate
          
          # Upgrade pip first
          pip install --upgrade pip
          
          # Install requirements with version checking
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            echo "Warning: requirements.txt not found"
            # Install common FastAPI dependencies
            pip install fastapi uvicorn[standard] sqlalchemy pydantic
          fi
          
          # 5. Set up environment variables
          echo "Setting up environment..."
          if [ -f ".env.production" ]; then
            sudo cp .env.production /etc/fastapi.env
          elif [ -f ".env" ]; then
            sudo cp .env /etc/fastapi.env
          fi
          
          # 6. Set permissions
          echo "Setting permissions..."
          sudo chown -R ${{ secrets.EC2_USER }}:www-data $APP_DIR
          sudo chmod -R 755 $APP_DIR
          sudo chmod -R 755 $APP_DIR/venv
          
          # 7. Database migrations (if using Alembic)
          if [ -f "alembic.ini" ]; then
            echo "Running database migrations..."
            alembic upgrade head
          fi
          
          # 8. Reload systemd and restart service
          echo "Restarting service..."
          sudo systemctl daemon-reload
          sudo systemctl restart fastapi.service
          
          # 9. Wait for service to start
          echo "Waiting for service to start..."
          sleep 5
          
          # 10. Verify service is running
          if sudo systemctl is-active --quiet fastapi.service; then
            echo "Service is running successfully!"
            sudo systemctl status fastapi.service --no-pager
            
            # 11. Health check
            echo "Performing health check..."
            # If your app has a health endpoint
            # curl -f http://localhost:8000/health || exit 1
          else
            echo "ERROR: Service failed to start!"
            sudo journalctl -u fastapi.service -n 50 --no-pager
            exit 1
          fi
          
          # 12. Cleanup old backups (keep last 5)
          echo "Cleaning up old backups..."
          ls -t $BACKUP_DIR/fastapi-backup-*.tar.gz | tail -n +6 | xargs -r sudo rm
          
          echo "Deployment completed successfully at $(date)"
      env:
        DEPLOY_TIMESTAMP: ${{ env.DEPLOY_TIMESTAMP }}

    - name: Health check after deploy
      run: |
        # Wait a bit for service to stabilize
        sleep 10
        
        # Try to check if service is reachable (adjust URL as needed)
        # curl -f http://${{ secrets.EC2_HOST }}:8000/docs || echo "Warning: Service might not be fully ready"
        echo "Deployment completed. Service should be available at http://${{ secrets.EC2_HOST }}:8000"

  rollback:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()  # Only run if deploy failed
    
    steps:
    - name: Rollback on EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          set -e
          APP_DIR="/var/www/fastapi-app"
          BACKUP_DIR="/var/www/backups"
          
          echo "Starting rollback due to deployment failure..."
          
          # Find latest backup
          LATEST_BACKUP=$(ls -t $BACKUP_DIR/fastapi-backup-*.tar.gz 2>/dev/null | head -n1)
          
          if [ -n "$LATEST_BACKUP" ]; then
            echo "Rolling back to: $LATEST_BACKUP"
            
            # Stop service
            sudo systemctl stop fastapi.service
            
            # Restore from backup
            sudo rm -rf $APP_DIR/*
            sudo tar -xzf "$LATEST_BACKUP" -C $APP_DIR
            
            # Restart service
            sudo systemctl start fastapi.service
            
            echo "Rollback completed successfully"
          else
            echo "No backup found for rollback"
          fi
